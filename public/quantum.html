<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quantum Flip Duel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html, body { margin: 0; padding: 0; background: #1a1b26; color: #fff; font-family: 'Segoe UI', Arial, sans-serif; }
    body { min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
    h1 { margin: 32px 0 14px 0; font-size: 2.7em; color: #7df9ff; text-shadow: 0 2px 12px #0ff9; letter-spacing: 2px;}
    .menu, .settings, .game, .end { display: none; flex-direction: column; align-items: center; width: 100%; }
    .show { display: flex !important; }
    .button {
      background: linear-gradient(90deg, #181825 80%, #7df9ff22 100%);
      border: 2.2px solid #7df9ff;
      color: #7df9ff;
      border-radius: 8px;
      font-size: 1.25em;
      font-weight: 600;
      padding: 13px 38px;
      margin: 15px 0 0 0;
      cursor: pointer;
      transition: background .17s, box-shadow .17s;
      text-align: center;
      box-shadow: 0 2px 16px #7df9ff22, 0 2px 20px #0002;
      outline: none;
    }
    .button:active {
      background: linear-gradient(90deg, #23233a 80%, #7df9ff33 100%);
    }
    .label { color: #7df9ff; font-weight: bold; margin-bottom: 4px; font-size: 1.1em;}
    .slider-wrap { display: flex; align-items: center; margin-bottom: 24px; }
    .slider { margin: 0 10px; accent-color: #7df9ff; }
    .select { font-size: 1.13em; padding: 4px 12px; border-radius: 7px; border: 1.5px solid #7df9ff; color: #7df9ff; background: #23233a; }
    #board { display: grid; grid-gap: 10px; margin: 32px 0 12px 0; }
    .cell {
      width: 54px; height: 54px; border-radius: 12px; border: none; outline: none;
      cursor: pointer; font-size: 1.5em; transition: background 0.16s, box-shadow 0.17s, color 0.15s;
      box-shadow: 0 3px 14px #0ff3, 0 1px 9px #0009;
      margin: 0; position: relative;
    }
    .cell.player {
      background: linear-gradient(145deg, #ecf6ff 70%, #bdf3fa 100%);
      color: #1a1b26;
      box-shadow: 0 0 12px #7df9ff88, 0 2px 14px #7df9ff55;
      border: 2px solid #7df9ff99;
    }
    .cell.ai {
      background: linear-gradient(145deg, #23233a 80%, #0a0a13 100%);
      color: #7df9ff;
      box-shadow: 0 1px 9px #0009;
      border: 2px solid #222638;
    }
    .cell.selected {
      outline: 4px solid #7df9ffcc !important;
      z-index: 2;
    }
    .cell.event {
      animation: eventFlash 0.9s;
      box-shadow: 0 0 28px 8px #f7d35499, 0 2px 14px #7df9ff55;
    }
    @keyframes eventFlash {
      0% { box-shadow: 0 0 28px 8px #f7d35499,0 2px 14px #7df9ff55;}
      40% { box-shadow: 0 0 44px 18px #ffe36b,0 2px 14px #7df9ff55;}
      100% { box-shadow: 0 0 28px 8px #f7d35499,0 2px 14px #7df9ff55;}
    }
    .settings-opt {
      margin-bottom: 18px;
    }
    #move-counter { font-size: 1.25em; margin-bottom: 6px; color: #7df9ff; font-weight: 600;}
    #whose-turn { margin-bottom: 16px; color: #7df9ff; font-size: 1.09em; }
    .end { text-align: center; }
    #winner { font-size: 2.1em; margin: 22px 0 10px 0; color: #7df9ff; text-shadow: 0 2px 12px #0ff6;}
    #final-count {font-size: 1.28em; color:#b3dcdf;}
    @media (max-width:600px) {
      #board { grid-gap: 4px; }
      .cell { width: 32px; height: 32px; font-size: 0.95em; }
      h1 { font-size: 1.3em; }
      .button { font-size: 1em; padding: 8px 16px;}
    }
    body:before {
      content: "";
      position: fixed;
      z-index: -1;
      inset:0;
      pointer-events:none;
      background: radial-gradient(circle at 20% 30%, #7df9ff22 0 40%, transparent 70%), radial-gradient(circle at 80% 70%, #7df9ff13 0 50%, transparent 80%);
      opacity: 1;
    }
    #event-msg {
      color: #ffe36b;
      background: #2c2c11;
      border: 2px solid #ffe36b;
      border-radius: 10px;
      font-size: 1.2em;
      padding: 10px 18px;
      margin-bottom: 11px;
      box-shadow: 0 0 14px #ffe36b66;
      animation: eventMsg 1.1s;
      display:none;
    }
    @keyframes eventMsg {
      0% { opacity:0; transform: scale(0.7);}
      60% { opacity:1; transform: scale(1.05);}
      100% { opacity:1; transform: scale(1);}
    }
  </style>
</head>
<body>
  <h1>Quantum Flip Duel</h1>
  <!-- Main Menu -->
  <div class="menu show" id="menu">
    <button class="button" id="play-btn">Play</button>
    <button class="button" id="settings-btn">Settings</button>
  </div>
  <!-- Settings Menu -->
  <div class="settings" id="settings">
    <div class="settings-opt">
      <div class="label">Move Limit:</div>
      <div class="slider-wrap">
        <span id="move-limit-val">30</span>
        <input id="move-limit-slider" class="slider" type="range" min="5" max="100" value="30">
      </div>
    </div>
    <div class="settings-opt">
      <div class="label">AI Difficulty:</div>
      <select id="difficulty" class="select">
        <option value="easy">Easy</option>
        <option value="medium">Medium</option>
        <option value="hard" selected>Hard</option>
      </select>
    </div>
    <div class="settings-opt">
      <div class="label">Board Size: <span id="board-size-val">6</span> x <span id="board-size-val2">6</span></div>
      <div class="slider-wrap">
        <input id="board-size-slider" class="slider" type="range" min="4" max="10" value="6">
      </div>
    </div>
    <div class="settings-opt">
      <label style="color:#ffe36b;font-weight:bold;font-size:1.09em;">
        <input type="checkbox" id="random-events" style="margin-right:8px; accent-color:#ffe36b;">
        Enable Random Events
      </label>
      <div style="font-size:0.94em;color:#ffe36b99;margin-top:2px;">(Surprise board flips at random!)</div>
    </div>
    <button class="button" id="settings-back" style="margin-top:22px;">Back</button>
  </div>
  <!-- Game UI -->
  <div class="game" id="game">
    <div id="event-msg"></div>
    <div id="move-counter">Moves: 30</div>
    <div id="whose-turn">Your Turn</div>
    <div id="board"></div>
    <button class="button" id="back-menu" style="margin-top:23px;">Main Menu</button>
  </div>
  <!-- End Screen -->
  <div class="end" id="end">
    <div id="winner"></div>
    <div id="final-count"></div>
    <button class="button" id="play-again">Play Again</button>
    <button class="button" id="end-menu">Main Menu</button>
  </div>
  <script>
    // --- State ---
    let SIZE = 6;
    let moveLimit = 30;
    let difficulty = "hard";
    let randomEvents = false;
    let board = [];
    let movesLeft = moveLimit;
    let playerTurn = true; // player = white
    // 0 = player/white, 1 = ai/black

    // UI elements
    const menu = document.getElementById('menu');
    const settings = document.getElementById('settings');
    const game = document.getElementById('game');
    const end = document.getElementById('end');
    const moveCounter = document.getElementById('move-counter');
    const whoseTurn = document.getElementById('whose-turn');
    const boardDiv = document.getElementById('board');
    const winnerDiv = document.getElementById('winner');
    const finalCountDiv = document.getElementById('final-count');
    const eventMsg = document.getElementById('event-msg');

    // --- Main Menu logic ---
    document.getElementById('play-btn').onclick = () => {
      show(game); hide(menu, settings, end);
      startGame();
    };
    document.getElementById('settings-btn').onclick = () => {
      show(settings); hide(menu, game, end);
    };
    document.getElementById('settings-back').onclick = () => {
      show(menu); hide(settings, game, end);
    };
    document.getElementById('back-menu').onclick = () => {
      show(menu); hide(game, settings, end);
    };
    document.getElementById('end-menu').onclick = () => {
      show(menu); hide(game, settings, end);
    };
    document.getElementById('play-again').onclick = () => {
      show(game); hide(menu, settings, end);
      startGame();
    };

    // --- Settings logic ---
    const moveLimitSlider = document.getElementById('move-limit-slider');
    const moveLimitVal = document.getElementById('move-limit-val');
    moveLimitSlider.oninput = () => {
      moveLimitVal.textContent = moveLimitSlider.value;
      moveLimit = parseInt(moveLimitSlider.value);
    };
    document.getElementById('difficulty').onchange = (e) => {
      difficulty = e.target.value;
    };
    // Board size
    const boardSizeSlider = document.getElementById('board-size-slider');
    const boardSizeVal = document.getElementById('board-size-val');
    const boardSizeVal2 = document.getElementById('board-size-val2');
    boardSizeSlider.oninput = () => {
      boardSizeVal.textContent = boardSizeSlider.value;
      boardSizeVal2.textContent = boardSizeSlider.value;
      SIZE = parseInt(boardSizeSlider.value);
    };
    // Random events
    document.getElementById('random-events').onchange = (e) => {
      randomEvents = e.target.checked;
    };

    // --- Helper functions ---
    function show(...els) { els.forEach(e => e.classList.add('show')); }
    function hide(...els) { els.forEach(e => e.classList.remove('show')); }

    // --- Game Logic ---
    function startGame() {
      movesLeft = moveLimit;
      playerTurn = true;
      // Fill left half with 0 (player/white), right half 1 (ai/black)
      board = [];
      for(let y=0; y<SIZE; ++y) {
        board[y] = [];
        for(let x=0; x<SIZE; ++x) {
          board[y][x] = x < SIZE/2 ? 0 : 1;
        }
      }
      updateUI();
      eventMsg.style.display = "none";
    }

    function updateUI() {
      moveCounter.textContent = `Moves: ${movesLeft}`;
      whoseTurn.textContent = playerTurn ? "Your Turn" : "AI's Turn";
      // render board
      boardDiv.innerHTML = '';
      boardDiv.style.gridTemplateColumns = `repeat(${SIZE}, minmax(24px,54px))`;
      for(let y=0; y<SIZE; ++y) {
        for(let x=0; x<SIZE; ++x) {
          const cell = document.createElement('button');
          cell.className = `cell ${board[y][x]===0?'player':'ai'}`;
          cell.dataset.x = x; cell.dataset.y = y;
          cell.disabled = !(playerTurn && board[y][x]===1); // can only click AI color on your turn
          cell.onclick = () => playerMove(x,y);
          boardDiv.appendChild(cell);
        }
      }
    }

    function playerMove(x, y) {
      if (!playerTurn || board[y][x]!==1) return;
      animateFlip(x, y, 0, ()=>{
        movesLeft--;
        playerTurn = false;
        updateUI();
        setTimeout(() => {
          if (movesLeft === 0) return endGame();
          aiMove();
        }, 550);
      });
    }

    // AI MOVES - FINAL LOGIC AS REQUESTED
    function aiMove() {
      // 1. Gather all possible moves with their benefit
      let moves = [];
      for (let y = 0; y < SIZE; ++y)
        for (let x = 0; x < SIZE; ++x)
          if (board[y][x] === 0) moves.push({ x, y });
      if (moves.length === 0) {
        movesLeft--;
        playerTurn = true;
        updateUI();
        if (movesLeft === 0) endGame();
        return;
      }

      // 2. Calculate benefit for all moves
      moves = moves.map(move => ({
        ...move,
        benefit: calcBenefit(move.x, move.y, 1)
      }));

      // 3. Sort moves by benefit (descending), but keep original order for ties
      moves.sort((a, b) => b.benefit - a.benefit);

      // 4. Assign ranks (1 = best, 2 = next, etc.) - ties share the same rank
      let rankedMoves = [];
      let currentRank = 1;
      for (let i = 0; i < moves.length; ++i) {
        if (i > 0 && moves[i].benefit < moves[i - 1].benefit) currentRank = i + 1;
        rankedMoves.push({ ...moves[i], rank: currentRank });
      }

      // 5. Pick a move according to difficulty
      let chosen = null;
      if (difficulty === "hard") {
        // Pick randomly among all moves with rank 1 (best benefit)
        let bestMoves = rankedMoves.filter(m => m.rank === 1);
        chosen = bestMoves[Math.floor(Math.random() * bestMoves.length)];
      } else if (difficulty === "medium") {
        // Pick randomly among moves with rank 1 to 12
        let mediumMoves = rankedMoves.filter(m => m.rank >= 1 && m.rank <= 12);
        chosen = mediumMoves[Math.floor(Math.random() * mediumMoves.length)];
      } else {
        // Easy: rank 1 to 25
        let easyMoves = rankedMoves.filter(m => m.rank >= 1 && m.rank <= 25);
        chosen = easyMoves[Math.floor(Math.random() * easyMoves.length)];
      }

      if (chosen) {
        animateFlip(chosen.x, chosen.y, 1, () => {
          movesLeft--;
          playerTurn = true;
          updateUI();
          if (movesLeft === 0) endGame();
          else if(randomEvents) setTimeout(triggerRandomEvent, 420);
        }, true);
      }
    }

    // Returns how many cells will be flipped to ai/player color if move is made
    function calcBenefit(x, y, forColor) {
      let flips = 0;
      if (board[y][x] !== forColor) {
        flips++;
      }
      [[0,1],[1,0],[-1,0],[0,-1]].forEach(([dx,dy])=>{
        let nx=x+dx, ny=y+dy;
        if(nx>=0&&nx<SIZE&&ny>=0&&ny<SIZE)
          if(board[ny][nx] !== forColor) flips++;
      });
      return flips;
    }

    // Flips and animates (adds .selected class), then calls cb when done
    function animateFlip(x, y, which, cb, ai=false) {
      let toFlip = [{x, y}];
      [[0,1],[1,0],[-1,0],[0,-1]].forEach(([dx,dy])=>{
        let nx=x+dx, ny=y+dy;
        if(nx>=0&&nx<SIZE&&ny>=0&&ny<SIZE)
          toFlip.push({x:nx, y:ny});
      });
      let cells = Array.from(boardDiv.children);
      toFlip.forEach(pos=>{
        let idx = pos.y*SIZE+pos.x;
        if (cells[idx]) {
          cells[idx].classList.add('selected');
        }
      });
      setTimeout(()=>{
        toFlip.forEach(pos=>{
          board[pos.y][pos.x]=1-board[pos.y][pos.x];
        });
        updateUI();
        setTimeout(()=>{
          toFlip.forEach(pos=>{
            let idx = pos.y*SIZE+pos.x;
            if (cells[idx]) {
              cells[idx].classList.remove('selected');
            }
          });
          if (cb) cb();
        }, ai ? 300 : 180);
      }, ai ? 300 : 140);
    }

    function triggerRandomEvent() {
      // 25% chance (1 in 4) per turn
      if (Math.random() < 0.25) {
        // Pick random event type: column or row (50/50)
        if (Math.random() < 0.5) {
          // Flip a random column
          let col = Math.floor(Math.random() * SIZE);
          for (let y = 0; y < SIZE; ++y) board[y][col] = 1 - board[y][col];
          highlightEvent("column", col);
          showEventMsg(`Random Event: Column ${col+1} fully flipped!`);
        } else {
          // Flip a random row
          let row = Math.floor(Math.random() * SIZE);
          for (let x = 0; x < SIZE; ++x) board[row][x] = 1 - board[row][x];
          highlightEvent("row", row);
          showEventMsg(`Random Event: Row ${row+1} fully flipped!`);
        }
        updateUI();
        setTimeout(()=>{eventMsg.style.display="none";}, 1250);
      }
    }
    function highlightEvent(type, idx) {
      let cells = Array.from(boardDiv.children);
      if(type==="column") {
        for(let y=0; y<SIZE; ++y) {
          let cell = cells[y*SIZE+idx];
          if(cell) cell.classList.add("event");
        }
      } else {
        for(let x=0; x<SIZE; ++x) {
          let cell = cells[idx*SIZE+x];
          if(cell) cell.classList.add("event");
        }
      }
      setTimeout(()=>{
        if(type==="column") {
          for(let y=0; y<SIZE; ++y) {
            let cell = cells[y*SIZE+idx];
            if(cell) cell.classList.remove("event");
          }
        } else {
          for(let x=0; x<SIZE; ++x) {
            let cell = cells[idx*SIZE+x];
            if(cell) cell.classList.remove("event");
          }
        }
      }, 1000);
    }
    function showEventMsg(msg) {
      eventMsg.textContent = msg;
      eventMsg.style.display = "block";
    }

    function endGame() {
      let player = 0, ai = 0;
      for(let y=0; y<SIZE; ++y) for(let x=0; x<SIZE; ++x)
        board[y][x]===0?player++:ai++;
      let winner;
      if (player > ai) winner = "You Win! 🎉";
      else if (ai > player) winner = "AI Wins! 🤖";
      else winner = "Draw!";
      winnerDiv.textContent = winner;
      finalCountDiv.textContent = `Final: You ${player} - AI ${ai}`;
      show(end); hide(game,menu,settings);
      eventMsg.style.display = "none";
    }

    // --- Start with main menu ---
    show(menu);
    // Set initial visuals for sliders
    moveLimitVal.textContent = moveLimitSlider.value;
    boardSizeVal.textContent = boardSizeSlider.value;
    boardSizeVal2.textContent = boardSizeSlider.value;
  </script>
</body>
</html>
